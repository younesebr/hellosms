name: Build APK with Buildozer

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          python3-dev \
          build-essential \
          autoconf \
          autoconf-archive \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          openssl \
          libsqlite3-dev \
          sqlite3 \
          bzip2 \
          libbz2-dev \
          libgdbm-dev \
          libgdbm-compat-dev \
          liblzma-dev \
          libreadline-dev \
          libncursesw5-dev \
          uuid-dev \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          libgstreamer1.0 \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          ccache
        echo "ACLOCAL_PATH=/usr/share/aclocal" >> $GITHUB_ENV
    
    - name: Install buildozer
      run: |
        pip3 install --user buildozer cython==0.29.19
    
    - name: Accept Android licenses
      run: |
        mkdir -p ~/.android/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.android/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/android-sdk-preview-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > ~/.android/licenses/android-sdk-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > ~/.android/licenses/android-googletv-license
        echo "33b6a2b64607f11b759f320ef9dff34ae516bf79" > ~/.android/licenses/android-sdk-arm-dbt-license
        echo "8403addf88ab4874007e1c1e80a0025de11b6375" > ~/.android/licenses/android-sdk-license-5
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/android-sdk-preview-license-528af877
    
    - name: Initialize buildozer
      run: |
        export PATH=$PATH:~/.local/bin
        export ACLOCAL_PATH=/usr/share/aclocal:$ACLOCAL_PATH
        yes | buildozer android update || buildozer android update
        sleep 3
    
    - name: Build APK with buildozer
      run: |
        export PATH=$PATH:~/.local/bin
        export ACLOCAL_PATH=/usr/share/aclocal:$ACLOCAL_PATH
        export AUTOMAKE=automake
        export AUTOCONF=autoconf
        export WARNINGS=
        
        # Function to patch libffi
        patch_libffi() {
          local libffi_dir=$(find ~/.buildozer -type d -name "libffi" -path "*/build/other_builds/*" | head -1)
          if [ -n "$libffi_dir" ] && [ -f "$libffi_dir/configure.ac" ]; then
            if ! grep -q "m4_ifndef.*LT_SYS_SYMBOL_USCORE" "$libffi_dir/configure.ac"; then
              echo "Patching libffi at: $libffi_dir"
              sed -i '/^AC_INIT/a\
        # Workaround for autoconf 2.71+: define LT_SYS_SYMBOL_USCORE\nm4_ifndef([LT_SYS_SYMBOL_USCORE], [m4_define([LT_SYS_SYMBOL_USCORE], [m4_if([$host_os], [cygwin* | mingw* | pw32* | os2*], [1], [0])])])' "$libffi_dir/configure.ac"
              echo "libffi patched"
            fi
            return 0
          fi
          return 1
        }
        
        # Build with retry on failure
        if ! yes | buildozer android debug; then
          echo "Build failed, patching libffi and retrying..."
          patch_libffi
          yes | buildozer android debug
        fi
      env:
        P4A_RELEASE_KEYSTORE: ""
        P4A_RELEASE_KEYALIAS: ""
        P4A_RELEASE_KEYSTORE_PASSWD: ""
        P4A_RELEASE_KEYALIAS_PASSWD: ""
    
    - name: List built APKs
      run: |
        ls -lh bin/*.apk || echo "No APK files found"
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: hellosms-apk-android11
        path: bin/*.apk
        retention-days: 30
